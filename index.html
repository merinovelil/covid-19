<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>

    <style type="text/css">
      body {
        font-family: "Open Sans", sans-serif;
        font-size: 16px;
        padding: 40px;
      }

      h1 {
        font-size: 3em;
        font-weight: 700;
        color: #f00;
        margin: 0;
      }

      a:visited {
        color: #000;
      }

      .legend {
        font: 11px sans-serif;
        background-color: #ffffff;
        position: absolute;
        float: right;
      }

      svg {
        cursor: crosshair;
      }

      path:hover {
        fill-opacity: 0.7;
      }

      .d3-tip {
        padding: 0 12px;
        background: rgba(255, 255, 255, 0.9);
        color: #000;
        border-radius: 2px;
        border: 2px solid black;
      }
    </style>
  </head>
  <body>
    <h1>Confirmed Coronavirus Cases in the USA</h1>
    <p>Data Source: <a href="https://github.com/montanaflynn/covid-19">https://github.com/montanaflynn/covid-19</a></p>
    
    <script type="text/javascript">
      // Width and height of map
      var width = 960;
      var height = 500;

      var lowColor = "#f9f9f9";
      var highColor = "#f00";

      // D3 Projection
      var projection = d3
        .geoAlbersUsa()
        .translate([width / 2, height / 2]) // translate to center of screen
        .scale([1000]); // scale things down so see entire US

      // Define path generator
      var path = d3
        .geoPath() // path generator that will convert GeoJSON to SVG paths
        .projection(projection); // tell path generator to use albersUsa projection

      //Create SVG element and append map to the SVG
      var svg = d3
        .select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      var dMap = d3.map();

      var tip = d3
        .tip()
        .attr("class", "d3-tip")
        .offset([-5, 0])
        .html(function(d) {
          if (d.properties) {
            var tip =
              "<p><b>" +
              d.properties.name +
              "</b></p><p>Confirmed cases: " +
              d.properties.confirmed +
              "</p>";
            return tip;
          } else {
            console.log("no dataRow", d);
            return d.properties.name + ": No data.";
          }
        });

      svg.call(tip);

      d3.json("https://montanaflynn.github.io/covid-19/data/current.json", function(rootData) {
        var data = Object.entries(rootData.states).map(([key, value]) => ({key,value}));
        var dataArray = [];
        for (var d = 0; d < data.length; d++) {
          dataArray.push(parseFloat(data[d].value.confirmed));
        }
        var minVal = d3.min(dataArray);
        var maxVal = d3.max(dataArray);
        var ramp = d3
          .scaleLinear()
          .domain([minVal, maxVal])
          .range([lowColor, highColor]);

        d3.json("https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_1_states_provinces_shp.geojson", function(json) {
          for (var i = 0; i < data.length; i++) {
            var dataState = data[i].key;
            var dataValue = data[i].value.confirmed;

            // Find the corresponding state inside the GeoJSON
            for (var j = 0; j < json.features.length; j++) {
              var jsonState = json.features[j].properties.name;

              if (dataState == jsonState) {
                // Copy the data value into the JSON
                json.features[j].properties.confirmed = dataValue;

                // Stop looking through the JSON
                break;
              }
            }
          }

          // Bind the data to the SVG and create one path per GeoJSON feature
          svg
            .selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
            .attr("d", path)
            .on("mouseover", tip.show)
            .on("mouseout", tip.hide)
            .style("stroke", "#000")
            .style("stroke-width", "1")
            .style("fill", function(d) {
              return ramp(d.properties.confirmed);
            });

          // add a legend
          var w = 140,
            h = 300;

          var key = d3
            .select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .attr("class", "legend");

          var legend = key
            .append("defs")
            .append("svg:linearGradient")
            .attr("id", "gradient")
            .attr("x1", "100%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "100%")
            .attr("spreadMethod", "pad");

          legend
            .append("stop")
            .attr("offset", "0%")
            .attr("stop-color", highColor)
            .attr("stop-opacity", 1);

          legend
            .append("stop")
            .attr("offset", "100%")
            .attr("stop-color", lowColor)
            .attr("stop-opacity", 1);

          key
            .append("rect")
            .attr("width", w - 100)
            .attr("height", h)
            .style("fill", "url(#gradient)")
            .attr("transform", "translate(0,10)");

          var y = d3
            .scaleLinear()
            .range([h, 0])
            .domain([minVal, maxVal]);

          var yAxis = d3.axisRight(y);

          key
            .append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(41,10)")
            .call(yAxis);
        });
      });
    </script>
  </body>
</html>
